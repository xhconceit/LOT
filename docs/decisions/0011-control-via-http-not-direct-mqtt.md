# ADR-0011：控制命令必须走 HTTP API（不允许客户端直连 MQTT）

## 状态

已采纳（Accepted）

## 背景

后续会通过小程序/APP 控制设备。如果让客户端直连 MQTT，会在以下方面失控或成本极高：

- 鉴权与授权（设备控制权限、只读/可控）
- 审计（谁在何时控制了哪台设备、结果如何）
- 限流与风控（误操作/刷指令）
- 可靠性（重试、超时、回执、幂等）
- 端侧限制（小程序网络与域名白名单、长连接稳定性）

## 决策

- 小程序/APP **必须**通过 `api-service`（HTTPS）创建控制命令
- 后端负责鉴权/授权/审计/限流/幂等/状态机
- 后端再通过 MQTT publish 下发到设备，并消费设备回执更新状态
- 禁止客户端直连 MQTT 作为控制通道

## 影响

- **正面**：安全可控；命令链路可观测；多端统一接入
- **代价**：需要实现命令状态机与设备回执协议；后端复杂度上升

## 参考

- `docs/control-spec.md`
