# 数据规范（MQTT → 入库 → 可视化）

本文件定义本项目的**数据约定**与**可执行规则**。任何实现都应以此为准。

## 1. MQTT Topic 约定

### 1.1 Topic 结构

Topic 由用户在后台配置（见 1.4），且**Topic 名称不承载任何业务语义**（无法从 topic 判断设备/部件/指标）。

- Topic 仅用于：订阅过滤、来源标记、调试定位（保留原始 topic）

### 1.2 解析规则（必须）

- **必须**：不对 Topic 做业务解析（不从 topic 推断 device/part/metric）
- **必须**：入库时保留原始 topic（用于追溯与排障）

> 设备归属见第 2 节“设备识别”。

### 1.3 订阅建议

```text
#
```

或按业务拆分更精确的订阅。

### 1.4 Topic 由后台配置（必须）

本项目**不在代码中硬编码订阅 Topic**。Topic（或 Topic Pattern）由用户在后台添加/维护，并在采集服务启动或配置变更时生效。

#### 1.4.1 配置形态

后台允许用户配置一个或多个订阅项（建议支持 MQTT 通配符）：

```text
#
```

每个订阅项至少包含：

- `name`：显示名称
- `pattern`：订阅 pattern（允许 `+` / `#`）
- `enabled`：是否启用

可选增强（后续需要再加）：

- `notes`：备注/用途说明
- `createdBy`、`createdAt`

#### 1.4.2 校验规则（必须）

- **必须**：`pattern` 不能为空
- **必须**：`pattern` 需满足 MQTT topic filter 语法（`+`、`#` 的位置合法）
- **必须**：对重复 pattern 去重（避免重复订阅）

#### 1.4.3 生效规则（必须）

- **必须**：服务启动时加载启用的订阅项并完成订阅
- **必须**：后台配置变更后，采集服务需要在可控时间内刷新订阅（重启或热更新均可，选一种并在实现时固定）

## 2. 消息体（Payload）约定

### 2.1 设备识别（必须）

由于 Topic 不能确定设备/部件/指标，本项目以 **payload 内的 `deviceId`** 作为设备唯一标识。

- **必须**：每条消息 payload 必须包含 `deviceId`
- **必须**：`deviceId` 建议仅使用 `[a-zA-Z0-9_-]`（避免空格与中文）
- **必须**：缺少/非法 `deviceId` 的消息不入库，并记录错误日志（含 topic 与原始 payload）

### 2.2 基础字段（推荐）

建议统一为 JSON（UTF-8）：

```json
{
  "deviceId": "dev_001",
  "ts": 1710000000000,
  "data": { "value": 12.34, "unit": "°C" },
  "type": "telemetry"
}
```

- **deviceId**：设备唯一标识（必填）
- **ts**：时间戳（毫秒），缺省时由服务端接收时间补齐
- **data**：业务数据（对象，字段可演进）
- **type**：消息类型/用途（例如 `telemetry` / `status` / `event`，可选但推荐）

### 2.3 原始数据保留（推荐）

无论是否解析出 `value`，建议保留原始 payload（用于追溯与兼容演进）。

## 3. 入库与建表规则（设备自动加表）

> 目标：新设备首次上报后可自动落库，无需手工建表。

### 3.1 触发条件（必须）

- **首次观察到**新的 `deviceId`（来自 payload）时触发建表（或注册记录）

### 3.2 表命名规则（建议）

```text
telemetry_{deviceId}
```

约束：

- **必须**：对 `deviceId` 做合法化（例如将非法字符替换为 `_`）
- **必须**：限制长度，避免超出 PostgreSQL 标识符限制

### 3.3 最小字段集合（建议）

- `id`：自增或 UUID
- `ts`：事件时间（毫秒或 timestamptz）
- `topic`：原始 MQTT topic（文本）
- `type`：消息类型（可选；来自 payload）
- `payload_raw`：原始 JSON（建议 JSONB）
- `ingested_at`：入库时间（timestamptz）

### 3.4 索引策略（建议）

- `(ts DESC)`
- 可选：`(type, ts DESC)`（如果你会按 type 查询）
- 可选：`(topic, ts DESC)`（如果你会按 topic 排查/过滤）

### 3.5 Schema 演进（必须先定策略）

二选一（建议先选 A，后期再优化）：

- **A. 宽表固定字段 + payload_raw(JSONB)**：新字段无需迁移，查询时从 JSONB 提取
- **B. 自动增列**：遇到新字段自动 `ALTER TABLE ADD COLUMN`（需严格的字段白名单与类型推断）

> 在未明确选择前，默认采用 **A**。

## 4. 失败与重试策略（占位）

- payload 校验失败（缺少/非法 `deviceId`，或非 JSON）
- 数据库连接失败
- 建表冲突（并发）

后续在 `docs/decisions/` 中补充决策记录。
